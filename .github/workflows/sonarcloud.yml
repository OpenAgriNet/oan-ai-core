name: SonarCloud

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: ["main"]

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # install your app deps (adjust if you use requirements-dev.txt / poetry / uv)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov

      - name: Run tests with coverage (if tests exist)
        env:
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
          ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
        run: |
          if find . -type f \( -name "test_*.py" -o -name "*_test.py" \) | grep -q .; then
            echo "Tests found, running pytest with coverage"
            pytest --cov=. --cov-report=xml:coverage.xml --cov-report=term-missing
          else
            echo "No tests found yet â€” skipping pytest"
          fi   

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=openagrinet
            -Dsonar.projectKey=OpenAgriNet_oan-ai-core
            -Dsonar.sources=.
            -Dsonar.exclusions=**/.venv/**,**/venv/**,**/__pycache__/**,**/*.pyc,**/.pytest_cache/**,**/build/**,**/dist/**,**/.eggs/**,**/*.egg-info/**
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
